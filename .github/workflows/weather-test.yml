name: Weather Test
on: workflow_dispatch

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: pip install pandas requests
        
      - name: Test Simple Update
        run: |
          echo "=== TEST STARTING ==="
          
          python3 << 'EOF'
import pandas as pd
import json
import os

print('1. Testing CSV load...')
df = pd.read_csv('blueflag_greece_scraped.csv')
print(f'   âœ… Loaded {len(df)} beaches')

print('2. Testing cache...')
if os.path.exists('weather_cache.json'):
    with open('weather_cache.json', 'r') as f:
        cache = json.load(f)
    print(f'   âœ… Cache has {len(cache)} entries')
else:
    print('   âš ï¸ No cache found, starting fresh')
    cache = {}

print('3. Testing API...')
import requests
import time
from datetime import datetime

# Test one beach
row = df.iloc[0]
lat = float(row['Latitude'])
lon = float(row['Longitude'])

try:
    url = f'https://api.open-meteo.com/v1/forecast?latitude={lat}&longitude={lon}&current=temperature_2m'
    response = requests.get(url, timeout=10)
    print(f'   âœ… API test passed: {response.status_code}')
    
    # Update cache
    key = f'{lat:.6f}_{lon:.6f}'
    cache[key] = {
        'beach_name': row['Name'],
        'test': 'success',
        'last_updated': datetime.now().isoformat()
    }
    
    # Save
    with open('weather_cache.json', 'w') as f:
        json.dump(cache, f, indent=2)
    print(f'   âœ… Saved cache with {len(cache)} entries')
    
except Exception as e:
    print(f'   âŒ API test failed: {e}')

print('ðŸŽ‰ TEST COMPLETE')
EOF
          
      - name: Show result
        run: |
          echo "=== RESULT ==="
          ls -la weather_cache.json
          if [ -f "weather_cache.json" ]; then
            echo "First 5 lines:"
            head -5 weather_cache.json
          fi
